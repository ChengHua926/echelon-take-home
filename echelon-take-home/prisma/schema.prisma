// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url   = env("DATABASE_URL")
}

// User model - Authentication layer
model User {
  id            String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email         String     @unique @db.VarChar
  passwordHash  String     @map("password_hash") @db.VarChar
  role          String     @db.VarChar // admin, hr, manager, employee
  createdAt     DateTime?  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime?  @default(now()) @map("updated_at") @db.Timestamp(6)

  // Relations
  employee      Employee?
  auditLogs     AuditLog[]
  chatSessions  ChatSession[]

  @@index([email], map: "idx_users_email")
  @@index([role], map: "idx_users_role")
  @@map("users")
}

// Employee model - Core HR data with org chart
model Employee {
  id            String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId        String?      @unique @map("user_id") @db.Uuid
  firstName     String       @map("first_name") @db.VarChar
  lastName      String       @map("last_name") @db.VarChar
  email         String       @unique @db.VarChar
  title         String       @db.VarChar
  department    String       @db.VarChar
  managerId     String?      @map("manager_id") @db.Uuid
  phone         String?      @db.VarChar
  hireDate      DateTime     @map("hire_date") @db.Date
  salary        Decimal?     @db.Decimal
  status        String?      @default("active") @db.VarChar // active, inactive, terminated
  createdAt     DateTime?    @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime?    @default(now()) @map("updated_at") @db.Timestamp(6)

  // Relations
  user          User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  manager       Employee?    @relation("EmployeeHierarchy", fields: [managerId], references: [id], onDelete: SetNull)
  directReports Employee[]   @relation("EmployeeHierarchy")
  teamMembers   TeamMember[]
  ledTeams      Team[]

  @@index([managerId], map: "idx_employees_manager")
  @@index([department], map: "idx_employees_department")
  @@index([status], map: "idx_employees_status")
  @@index([userId], map: "idx_employees_user_id")
  @@index([email], map: "idx_employees_email")
  @@map("employees")
}

// Team model - Matrix organization with hierarchy
model Team {
  id            String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name          String       @db.VarChar
  description   String?      @db.Text
  parentTeamId  String?      @map("parent_team_id") @db.Uuid
  teamLeadId    String?      @map("team_lead_id") @db.Uuid
  createdAt     DateTime?    @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime?    @default(now()) @map("updated_at") @db.Timestamp(6)

  // Relations
  parentTeam    Team?        @relation("TeamHierarchy", fields: [parentTeamId], references: [id], onDelete: SetNull)
  subTeams      Team[]       @relation("TeamHierarchy")
  teamLead      Employee?    @relation(fields: [teamLeadId], references: [id], onDelete: SetNull)
  members       TeamMember[]

  @@index([parentTeamId], map: "idx_teams_parent")
  @@index([teamLeadId], map: "idx_teams_lead")
  @@map("teams")
}

// TeamMember model - Many-to-many junction table
model TeamMember {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  teamId      String    @map("team_id") @db.Uuid
  employeeId  String    @map("employee_id") @db.Uuid
  joinedAt    DateTime? @default(now()) @map("joined_at") @db.Timestamp(6)

  // Relations
  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([teamId, employeeId])
  @@index([teamId], map: "idx_team_members_team")
  @@index([employeeId], map: "idx_team_members_employee")
  @@map("team_members")
}

// AuditLog model - Change tracking with JSONB
model AuditLog {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId      String?   @map("user_id") @db.Uuid
  entityType  String    @map("entity_type") @db.VarChar
  entityId    String    @map("entity_id") @db.Uuid
  action      String    @db.VarChar // create, update, delete
  changes     Json?     @db.JsonB
  ipAddress   String?   @map("ip_address") @db.VarChar
  timestamp   DateTime? @default(now()) @db.Timestamp(6)

  // Relations
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId], map: "idx_audit_logs_entity")
  @@index([userId], map: "idx_audit_logs_user")
  @@index([timestamp(sort: Desc)], map: "idx_audit_logs_timestamp")
  @@map("audit_logs")
}

// ChatSession model - AI chat conversations
model ChatSession {
  id             String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId         String              @map("user_id") @db.Uuid
  title          String?             @db.VarChar
  deletedAt      DateTime?           @map("deleted_at") @db.Timestamp(6)
  totalTokens    Int                 @default(0) @map("total_tokens")
  createdAt      DateTime?           @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime?           @default(now()) @map("updated_at") @db.Timestamp(6)

  // Relations
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages       ChatMessage[]
  toolExecutions ChatToolExecution[]

  @@index([userId], map: "idx_chat_sessions_user")
  @@index([deletedAt], map: "idx_chat_sessions_deleted")
  @@index([updatedAt(sort: Desc)], map: "idx_chat_sessions_updated")
  @@map("chat_sessions")
}

// ChatMessage model - Individual messages in conversations
model ChatMessage {
  id             String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sessionId      String              @map("session_id") @db.Uuid
  role           String              @db.VarChar // user, assistant, system, tool
  content        String?             @db.Text
  toolCalls      Json?               @map("tool_calls") @db.JsonB
  toolCallId     String?             @map("tool_call_id") @db.VarChar
  tokens         Int?                @default(0)
  createdAt      DateTime?           @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  session        ChatSession         @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  toolExecutions ChatToolExecution[]

  @@index([sessionId], map: "idx_chat_messages_session")
  @@index([createdAt], map: "idx_chat_messages_created")
  @@index([role], map: "idx_chat_messages_role")
  @@index([sessionId, createdAt], map: "idx_chat_messages_session_created")
  @@map("chat_messages")
}

// ChatToolExecution model - Track tool usage in chat
model ChatToolExecution {
  id              String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  messageId       String       @map("message_id") @db.Uuid
  sessionId       String       @map("session_id") @db.Uuid
  toolName        String       @map("tool_name") @db.VarChar
  parameters      Json         @db.JsonB
  result          Json?        @db.JsonB
  executionTimeMs Int?         @map("execution_time_ms")
  success         Boolean?     @default(true)
  errorMessage    String?      @map("error_message") @db.Text
  executedAt      DateTime?    @default(now()) @map("executed_at") @db.Timestamp(6)

  // Relations
  message         ChatMessage  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  session         ChatSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId], map: "idx_tool_executions_session")
  @@index([messageId], map: "idx_tool_executions_message")
  @@index([toolName], map: "idx_tool_executions_tool_name")
  @@index([executedAt(sort: Desc)], map: "idx_tool_executions_executed")
  @@map("chat_tool_executions")
}
